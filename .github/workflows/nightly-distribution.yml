name: MODFLOW 6 distribution (nightly build with Intel)
on:
  schedule:
    - cron: '0 2 * * *' # run at 2 AM UTC
  push:
    branches:
      - master
      - ci-diagnose*
  pull_request:
    branches:
      - master
env:
  FC: ifort
jobs:
  build_for_os:
    name: build distribution
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-20.04, macos-latest, windows-latest]
    defaults:
      run:
        shell: bash
    steps:

      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.9

      - name: Install Python packages
        run: |
          pip install -r requirements.txt
          pip list

      - name: Install ifort
        uses: modflowpy/install-intelfortran-action@v1

      - name: Install TeX Live and usgslatex
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt install texlive-latex-extra texlive-science texlive-font-utils
          sudo apt install texlive-fonts-extra
          git clone https://github.com/MODFLOW-USGS/usgslatex.git usgslatex
          cd ./usgslatex/usgsLaTeX
          sudo ./install.sh --all-users

      - name: Checkout modflow6
        uses: actions/checkout@v3
        with:
          repository: MODFLOW-USGS/modflow6
          path: modflow6
          ref: develop

      - name: Checkout modflow6 examples
        uses: actions/checkout@v3
        with:
          repository: MODFLOW-USGS/modflow6-examples
          path: modflow6-examples

      - name: Update flopy classes
        working-directory: modflow6/autotest
        run: python update_flopy.py

      - name: Install MODFLOW executables release
        uses: modflowpy/install-modflow-action@v1
        with:
          subset: 'triangle,gridgen'

      - name: Create distribution
        run: python make_distribution.py -mf6p ./modflow6 -mf6ep ./modflow6-examples -dp ./${{ runner.os }}

      - name: Create distribution artifact
        uses: actions/upload-artifact@v3
        with:
          name: ${{ runner.os }}
          path: |
            ./${{ runner.os }}.zip
